<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>TBSS/UserGuide</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="fsl/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="fsl/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="fsl/css/print.css">
<style type="text/css">
ul.pagetitle{
  display: inline;
  margin: 0;
  padding: 0;
  font-size: 1.5em;
}
li.pagetitle{
  display: inline;
  margin: 0;
}
td.noborder {
  border: 0;
}
</style>
</head>
<body>
<table>
<tr>
<td class="noborder">
<img src="logo.png">
</td>
<td class="noborder">
<ul class="pagetitle">
<li class="pagetitle"><a class="backlink">TBSS/UserGuide</a>
</ul>
<br><br>
[<a href="FSL.html">FSL</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]&nbsp;
</td>
</tr>
</table>
<hr>
<div id="page">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867"><div class="FslToolContents">
<h1>Contents</h1>
<ol><li><a href="./TBSS.html">Introduction</a></li><li>User Guide<div class="contentslist"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="#Running_TBSS">Running TBSS</a><ol><li>
<a href="#create_FA_data_from_a_diffusion_MRI_study">create FA data from a diffusion MRI study</a></li><li>
<a href="#tbss_1_preproc">tbss_1_preproc</a></li><li>
<a href="#tbss_2_reg">tbss_2_reg</a></li><li>
<a href="#tbss_3_postreg">tbss_3_postreg</a></li><li>
<a href="#tbss_4_prestats">tbss_4_prestats</a></li><li>
<a href="#voxelwise_statistics_on_the_skeletonised_FA_data">voxelwise statistics on the skeletonised FA data</a></li></ol></li><li>
<a href="#Using_non-FA_Images_in_TBSS">Using non-FA Images in TBSS</a></li><li>
<a href="#Using_crossing-fibre_measures">Using crossing-fibre measures</a></li><li>
<a href="#Testing_left_vs._right_in_TBSS">Testing left vs. right in TBSS</a></li><li>
<a href="#Displaying_TBSS_Results">Displaying TBSS Results</a></li><li>
<a href="#Transforming_TBSS_results_back_to_native_space">Transforming TBSS results back to native space</a></li><li>
<a href="#What.27s_new_in_this_version">What's new in this version</a></li></ol></div></div></li><li><a href="./TBSS(2f)Faq.html">FAQ</a></li><li><a href="./TBSS(2f)FurtherInformation.html">Further Information</a></li></ol></div> <span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-4"></span>
<h1 id="Running_TBSS">Running TBSS</h1>
<span class="anchor" id="line-5"></span><p class="line874">Overview: running TBSS involves a few simple steps: <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><ul><li>create FA images from your diffusion study data <span class="anchor" id="line-8"></span></li><li>tbss_1_preproc - prepare your FA data in your TBSS working directory in the right format <span class="anchor" id="line-9"></span></li><li>tbss_2_reg - apply nonlinear registration of all FA images into standard space <span class="anchor" id="line-10"></span></li><li>tbss_3_postreg - create the mean FA image and skeletonise it <span class="anchor" id="line-11"></span></li><li>tbss_4_prestats - project all subjects' FA data onto the mean FA skeleton <span class="anchor" id="line-12"></span></li><li>stats (e.g., randomise) - feed the 4D projected FA data into GLM modelling and thresholding in order to find voxels which correlate with your model. <span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span></li></ul><p class="line874">We now go through the TBSS steps in detail. <span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-17"></span>
<h2 id="create_FA_data_from_a_diffusion_MRI_study">create FA data from a diffusion MRI study</h2>
<span class="anchor" id="line-18"></span><p class="line862">In order to run TBSS you need to create a single FA image from each subject in the study. We recommend that you do this using tools in the <a href="./FDT.html">FDT</a> FSL toolbox; in brief: <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span><ol type="1"><li>Correct your original data for the effects of head movement and eddy currents using eddy_correct <span class="anchor" id="line-21"></span></li><li>Create a brain mask by running bet on one of the B=0 (no diffusion weighting) images <span class="anchor" id="line-22"></span></li><li>Fit the diffusion tensor model using dtifit <span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span></li></ol><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-25"></span>
<h2 id="tbss_1_preproc">tbss_1_preproc</h2>
<span class="anchor" id="line-26"></span><p class="line874">You now need to create a new, empty directory (folder) in which you will run the TBSS analysis, for example: <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><p class="line867"><span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span><pre><span class="anchor" id="line-1"></span>mkdir mytbss</pre><span class="anchor" id="line-31"></span><p class="line874">Then copy into there all of your subjects' FA images, giving each subject's FA image a different name. You will make later analysis easier if you name the images in a logical order, for example so that all controls are listed before all patients: <span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span><p class="line867"><span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><pre><span class="anchor" id="line-1-1"></span>cd mytbss
<span class="anchor" id="line-2"></span>ls
<span class="anchor" id="line-3"></span>  CON_N00300_dti_data_FA.nii.gz
<span class="anchor" id="line-4"></span>  CON_N00302_dti_data_FA.nii.gz
<span class="anchor" id="line-5"></span>  CON_N00499_dti_data_FA.nii.gz
<span class="anchor" id="line-6"></span>  PAT_N00373_dti_data_FA.nii.gz
<span class="anchor" id="line-7"></span>  PAT_N00422_dti_data_FA.nii.gz
<span class="anchor" id="line-8"></span>  PAT_N03600_dti_data_FA.nii.gz</pre><span class="anchor" id="line-43"></span><p class="line874">You are now nearly ready to run the first TBSS script, which will erode your FA images slightly and zero the end slices (to remove likely outliers from the diffusion tensor fitting). Type: <span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><p class="line867"><span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><pre><span class="anchor" id="line-1-2"></span>tbss_1_preproc *.nii.gz</pre><span class="anchor" id="line-48"></span><p class="line862">(the * expands to the list of input images). The script will move all the processed FA images into a new sub-directory called <tt>FA</tt> (where all the registration steps will later take place,) and will also create another sub-directory called <tt>origdata</tt> and place all your original images in there for posterity. <span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span><p class="line862">Finally, the script runs <tt>slicesdir</tt>, which creates an overview webpage containing a static view of each of the input images, so that you can then quickly view each of them for obvious problems. <span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-53"></span>
<h2 id="tbss_2_reg">tbss_2_reg</h2>
<span class="anchor" id="line-54"></span><p class="line862">The next TBSS script (<tt>tbss_2_reg</tt>) runs the nonlinear registration, aligning all FA images to a 1x1x1mm standard space. The target image used in the registrations can either be a pre-defined target, or can be automatically chosen to be the most "typical" subject in the study. In general we recommend using the <tt>FMRIB58_FA</tt> standard-space image as the target in TBSS. This involves carrying out just one registration per subject and generally gives good alignment results. This option is applied by using the -T flag. Alternatively, you can supply your own target image by using the -t option. <span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span><p class="line874">The third option is to align every FA image to every other one, identify the "most representative" one, and use this as the target image. This target image is then affine-aligned into MNI152 standard space, and every image is transformed into 1x1x1mm MNI152 space by combining the nonlinear transform to the target FA image with the affine transform from that target to MNI152 space. This option is selected by using the -n flag, and is the recommended option if you need to generate a study-specific, for example if the subjects are all young children (and hence the adult-derived FMRIB58_FA target is inappropriate). <span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span><p class="line874">Direct registration to the high resolution FMRIB58_FA image takes about 10 minutes x N subjects (when running on a single computer). In comparison, the all-subjects-to-all-subjects option takes about 5 minutes x N x N. Hence the latter approach can take much longer to run than the former. <span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span><p class="line862">If your lab has a batch submission system (e.g., SGE) then you may want to setup FSL to take advantage of this - then all the registration jobs get submitted to the batch system for parallel processing. In this case, ask your system administrator to edit <tt>$FSLDIR/bin/fsl_sub</tt> in order to setup FSL to make use of your cluster environment. Once this is done, running <tt>tbss_2_reg</tt> submits all the registrations to your batch system, and you need to watch for them all to complete before moving on to the next stage of TBSS. <span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span><p class="line874">Once all the registrations have finished running, you are ready to move onto the next step. <span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-65"></span>
<h2 id="tbss_3_postreg">tbss_3_postreg</h2>
<span class="anchor" id="line-66"></span><p class="line874">The next TBSS script applies the nonlinear transforms found in the previous stage to all subjects to bring them into standard space. <span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><p class="line874">If the previous stage was run with the -n option (find the most typical subject as the target), then this script first needs to make the decision about which of your FA images is the most "typical", for selection as the target image to apply all nonlinear transformations into the space of. (The script does this by taking each FA image in turn, and estimating the average amount of warping that was necessary to align all other images to it; it then finds the one that had the smallest amount of average warping when used as a target.) Obviously if you pre-specified the FA target image then this step is automatically skipped. The script then takes the target and affine-aligns it into 1x1x1mm MNI152 space - this resolution is chosen as the later skeletonisation and projection steps work well at this resolution, and the choice of working in MNI152 space is chosen for convenience of display and coordinate reporting later. Once this is done, each subject's FA image has the nonlinear transform to the target and then the affine transform to MNI152 space applied, resulting in a transformation of the original FA image into MNI152 space (actually the two transformations are combined before being applied, to avoid having to resample the image twice). <span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span><p class="line862">The above results in a standard-space version of each subject's FA image; next these are all merged into a single 4D image file called <tt>all_FA</tt>, created in a new subdirectory called <tt>stats</tt>. Next, the mean of all FA images is created, called <tt>mean_FA</tt>, and this is then fed into the FA skeletonisation program to create <tt>mean_FA_skeleton</tt>. <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><p class="line874">All of the above is done simply by running the script: <span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><p class="line867"><span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><pre><span class="anchor" id="line-1-3"></span>tbss_3_postreg -S</pre><span class="anchor" id="line-77"></span><p class="line874">Alternatively, if you wish to use the FMRIB58_FA mean FA image and its derived skeleton, instead of the mean of your subjects in the study, use the -T option: <span class="anchor" id="line-78"></span><span class="anchor" id="line-79"></span><p class="line867"><span class="anchor" id="line-80"></span><span class="anchor" id="line-81"></span><pre><span class="anchor" id="line-1-4"></span>tbss_3_postreg -T</pre><span class="anchor" id="line-82"></span><p class="line874">In general we would recommend using the -S option (derive the mean FA and skeleton from the actual subjects you have). <span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><p class="line874">The script finishes by telling you to check whether a suitable threshold for the mean FA skeleton is 0.2 (a typical value used by the next script). For example, load the 4D FA data and the skeleton into FSLView: <span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span><p class="line867"><span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span><pre><span class="anchor" id="line-1-5"></span>cd stats
<span class="anchor" id="line-2-1"></span>fslview all_FA -b 0,0.8 mean_FA_skeleton -b 0.2,0.8 -l Green</pre><span class="anchor" id="line-90"></span><p class="line867"><img align="right" alt="eg_skel_all_FA.png" class="attachment" src="attachments/TBSS(2f)UserGuide/eg_skel_all_FA.png" title="eg_skel_all_FA.png" />  The -b option sets sensible display range options, and in the case of the skeleton image, also controls the thresholding applied. Now turn on the movie loop; you will see the mean FA skeleton on top of each different subject's aligned FA image. If all the processing so far has worked ok the skeleton should look like the examples shown here (see the TBSS paper for more examples of different subjects' results underneath the skeleton). If the registration has worked well you should see that in general each subject's major tracts are reasonably well aligned to the relevant parts of the skeleton. If you set the skeleton threshold (in FSLView, the lower of the display range settings) much lower than 0.2, it will extend away towards extremes where there is too much cross-subject variability and where the nonlinear registration has not been able to attain good alignments. Remember the skeleton threshold for the next stage. <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-93"></span>
<h2 id="tbss_4_prestats">tbss_4_prestats</h2>
<span class="anchor" id="line-94"></span><p class="line874">The last TBSS script carries out the final steps necessary before you run the voxelwise cross-subject stats. It thresholds the mean FA skeleton image at the chosen threshold - a common value that works well is 0.2 (see above). To run, type: <span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><p class="line867"><span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><pre><span class="anchor" id="line-1-6"></span>tbss_4_prestats 0.2</pre><span class="anchor" id="line-99"></span><p class="line874">replacing the 0.2 with another value if you need to change it. <span class="anchor" id="line-100"></span><span class="anchor" id="line-101"></span><p class="line862">The resulting binary skeleton mask defines the set of voxels used in all subsequent processing. Next a "distance map" is created from the skeleton mask. This is used in the projection of FA onto the skeleton (see the TBSS paper for more detail). Finally, the script takes the 4D <tt>all_FA</tt> image (containing all subjects' aligned FA data) and, for each "timepoint" (i.e., subject ID), projects the FA data onto the mean FA skeleton. This results in a 4D image file containing the (projected) skeletonised FA data. It is this file that you will feed into voxelwise statistics in the next section. <span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-104"></span>
<h2 id="voxelwise_statistics_on_the_skeletonised_FA_data">voxelwise statistics on the skeletonised FA data</h2>
<span class="anchor" id="line-105"></span><p class="line862">The previous step resulted in the 4D skeletonised FA image <tt>all_FA_skeletonised</tt> (in the <tt>stats</tt> subdirectory). It is this that you now feed into voxelwise statistics, that, for example, tells you which FA skeleton voxels are significantly different between two groups of subjects. <span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><p class="line862">One recommended way of doing the stats is to use the randomise tool. For more detail see the <a href="./randomise.html">randomise</a> manual. Before running randomise you will need to generate a design matrix file, e.g., <tt>design.mat</tt> and contrasts file, e.g., <tt>design.con</tt>. You can use the script <tt>design_ttest2</tt> in the simple case of a two-group comparison. Alternatively you can use the <tt>Glm</tt> GUI to generate these design matrix and contrast files. Note that the order of the entries (rows) in your design matrix must match the alphabetical order of your original FA images, as that determines the order of the aligned FA images in the final 4D file <tt>all_FA_skeletonised</tt>; check this with: <span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span><p class="line867"><span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span><pre><span class="anchor" id="line-1-7"></span>cd FA
<span class="anchor" id="line-2-2"></span>imglob *_FA.*</pre><span class="anchor" id="line-113"></span><p class="line862">We recommend using the TFCE (Threshold-Free Cluster Enhancement) option in randomise. This is somewhat similar to cluster-based thresholding, but generally more robust and avoids the need for the arbitrary initial cluster-forming threshold. To use this on TBSS-preprocessed data, add the <tt>--T2</tt> option to randomise. <span class="anchor" id="line-114"></span><span class="anchor" id="line-115"></span><p class="line862">So, say you have 7 controls (with original filenames <tt>CON_001_dti_FA.nii.gz</tt> etc.) and 11 patients (with original filenames <tt>PAT_001_dti_FA.nii.gz</tt> etc.). You can generate design files and run voxelwise statistics and inference using randomisation, including cluster-based thresholding, using: <span class="anchor" id="line-116"></span><span class="anchor" id="line-117"></span><p class="line867"><span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span><span class="anchor" id="line-120"></span><span class="anchor" id="line-121"></span><span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span><span class="anchor" id="line-124"></span><pre><span class="anchor" id="line-1-8"></span>cd ../stats
<span class="anchor" id="line-2-3"></span>design_ttest2 design 7 11
<span class="anchor" id="line-3-1"></span>
<span class="anchor" id="line-4-1"></span>randomise -i all_FA_skeletonised -o tbss -m mean_FA_skeleton_mask -d design.mat -t design.con -n 500 --T2
<span class="anchor" id="line-5-1"></span>
<span class="anchor" id="line-6-1"></span>fslview $FSLDIR/data/standard/MNI152_T1_1mm mean_FA_skeleton -l Green -b 0.2,0.8 tbss_tstat1 -l Red-Yellow -b 3,6 tbss_tstat2 -l Blue-Lightblue -b 3,6</pre><span class="anchor" id="line-125"></span><p class="line862">In this case, contrast 1 gives the control&gt;patient test and contrast 2 gives the control&lt;patient test. The raw (unthresholded) tstat images are <tt>tbss_tstat1</tt> and <tt>tbss_tstat2</tt> respectively. The TFCE p-value images (fully corrected for multiple comparisons across space) are <tt>tbss_tfce_corrp_tstat1</tt> and <tt>tbss_tfce_corrp_tstat2</tt> (note, these are actually 1-p for convenience of display, so thresholding at .95 gives significant clusters). <span class="anchor" id="line-126"></span><span class="anchor" id="line-127"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-128"></span>
<h1 id="Using_non-FA_Images_in_TBSS">Using non-FA Images in TBSS</h1>
<span class="anchor" id="line-129"></span><p class="line874">It is straightforward to apply TBSS to other diffusion-derived data than FA images. For example, you may be interested in how MD (mean diffusivity) or the first diffusion tensor eigenvalue varies between different subjects. <span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span><p class="line862">To achieve this we recommend using the FA images to achieve the nonlinear registration and skeletonisation stages, and also to estimate the projection vectors from each individual subject onto the mean FA skeleton. The nonlinear warps and skeleton projection can then also be applied to other images such as the second eigenvalue. The following instructions assume that you want to run TBSS on the second eigenvalue, named <tt>L2</tt> by <tt>dtifit</tt>: <span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span><ul><li>Run the full TBSS analysis (see all steps above) on your FA data. <span class="anchor" id="line-134"></span></li><li><p class="line862">Create a new directory called L2 (or any other name) in your TBSS analysis directory (the one that contains the existing origdata, FA and stats directories from the FA analysis). Type: <tt>mkdir&nbsp;L2</tt> <span class="anchor" id="line-135"></span></li><li>Copy your L2 images into this new directory, making sure that they are named exactly the same as the original FA images were (look in origdata to check the original names - and keep them exactly the same, even if they include FA, which can be confusing; e.g. if there is an image origdata/subj005_FA.nii.gz then you need an image L2/subj005_FA.nii.gz and this file should contain the L2 data, even though it has FA in the name). <span class="anchor" id="line-136"></span></li><li><p class="line862">Now, making sure that you are in your top working TBSS directory (the one that now contains FA, stats and L2 subdirectories) and run the <tt>tbss_non_FA</tt> script, telling it that the alternate data is called <tt>L2</tt>. This will apply the original nonlinear registration to the L2 data, merge all subjects' warped L2 data into a 4D file <tt>stats/all_L2</tt>, project this onto the original mean FA skeleton (using the original FA data to find the projection vectors), resulting in the 4D projected data <tt>stats/all_L2_skeletonised</tt>. Run: <tt>tbss_non_FA&nbsp;L2</tt> <span class="anchor" id="line-137"></span></li><li><p class="line862">You can now run voxelwise stats on the projected 4D data <tt>all_L2_skeletonised</tt> in the same manner as described above. <span class="anchor" id="line-138"></span><span class="anchor" id="line-139"></span></li></ul><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-140"></span>
<h1 id="Using_crossing-fibre_measures">Using crossing-fibre measures</h1>
<span class="anchor" id="line-141"></span><p class="line862">If you use this option, please site this paper: <a class="http" href="http://www.ncbi.nlm.nih.gov/pubmed/19712743">S. Jbabdi, T. E. Behrens, and S. M. Smith. Crossing fibres in tract-based spatial statistics. NeuroImage, 49:249-256, 2010.</a> <span class="anchor" id="line-142"></span><span class="anchor" id="line-143"></span><p class="line874">The interpretation of FA changes in crossing-fibre regions can be ambiguous. One solution is to use models that incorporate fibre-specific measurements, i.e. two or more measurements that relate to two or more fibre orientations within each voxel. For example, you may use partial volume fraction estimates from bedpostX instead of FA at each voxel. If you estimate orientations x1 and x2, together with their partial volume fractions f1 and f2, you may want to use f1 and f2 instead of FA which should increase the interpretability of the results in crossing fibre areas. <span class="anchor" id="line-144"></span><span class="anchor" id="line-145"></span><p class="line874">When using measurements that are orientation specific, it is not sufficient to use tbss_non_FA, because we need to ensure that a fibre orientation x1 in a subject corresponds to the same fibre population across all subjects. The ouput of bedpostX may be such that x1 relates to a given pathway (say cortico-spinal tract) in a subset of the subjects, but to another tract (e.g. SLF) in other subjects. I.e. x1 and x2 are swapped between those two subsets of subjects. <span class="anchor" id="line-146"></span><span class="anchor" id="line-147"></span><p class="line874">TBSS deals with these situations automatically, via the use of the tbss_x script. As for tbss_non_FA, you can use FA for the nonlinear registration and skeletonisation stages, and also to estimate the projection vectors from each individual subject onto the mean FA skeleton. The nonlinear warps and skeleton projection can then be applied to crossing fibre measurements. The following instructions assume that you are using bedpostX estimates of fibres orientations (dyads1,dyads2,etc.) and related partial volumes (f1,f2,etc). You can replace these with any other orientation-dependent measurements (e.g. using another diffusion model). <span class="anchor" id="line-148"></span><span class="anchor" id="line-149"></span><p class="line874">* Run the full TBSS analysis (see all steps above) on your FA data. * Create one directory per orientation and per measurement in your TBSS analysis directory (the one that contains the existing origdata, FA and stats directories from the FA analysis): <span class="anchor" id="line-150"></span><span class="anchor" id="line-151"></span><p class="line867"><span class="anchor" id="line-152"></span><span class="anchor" id="line-153"></span><pre><span class="anchor" id="line-1-9"></span>mkdir F1 F2 D1 D2</pre><span class="anchor" id="line-154"></span><p class="line874">* Copy your images into this new directory, making sure that they are named exactly the same as the original FA images were (look in origdata to check the original names). For example, if you are using bedpostX outputs, copy the dyads (dyads1,dyads2,etc.) onto D1,D2,etc., and the partial volumes (mean_f1samples, mean_f2samples,etc.) onto F1,F2,etc. * Now, making sure that you are in your top working TBSS directory (the one that contains FA, stats and origdata subdirectories) and run the tbss_x script: <span class="anchor" id="line-155"></span><span class="anchor" id="line-156"></span><p class="line867"><span class="anchor" id="line-157"></span><span class="anchor" id="line-158"></span><pre><span class="anchor" id="line-1-10"></span>tbss_x F1 F2 D1 D2</pre><span class="anchor" id="line-159"></span><p class="line874">This will apply the original nonlinear registration to the data in F* and D*, then perform a series of operations that ensure that F* will be associated with the same orientations across subjects. * You can now run voxelwise stats on the output 4D data all_F*_x_skeletonised as described above. <span class="anchor" id="line-160"></span><span class="anchor" id="line-161"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-162"></span>
<h1 id="Testing_left_vs._right_in_TBSS">Testing left vs. right in TBSS</h1>
<span class="anchor" id="line-163"></span><p class="line874">In order to test skeleton voxels on the left of the brain vs. those on the right (i.e., testing for asymmetries in diffusion characteristics), it is necessary to derive (and project onto) a slightly different mean FA skeleton - one that is symmetric. Obviously this skeleton needs to be restricted to only those parts of the "original" skeleton that are already sufficiently close to being symmetric - i.e. where there is reasonable correspondence in general tract structure between left and right in the brain. <span class="anchor" id="line-164"></span><span class="anchor" id="line-165"></span><p class="line862">To run such analysis, first complete the above TBSS processing steps 1-4. Then <tt>cd</tt> into the <tt>stats</tt> subdirectory in your TBSS analysis. Use the script <tt>tbss_sym</tt>; if you want to apply the symmetry analysis to the FA data, type <span class="anchor" id="line-166"></span><span class="anchor" id="line-167"></span><p class="line867"><span class="anchor" id="line-168"></span><span class="anchor" id="line-169"></span><pre><span class="anchor" id="line-1-11"></span>tbss_sym FA</pre><span class="anchor" id="line-170"></span><p class="line862">or if you want to apply it to other diffusion data (that has previously been processed using <tt>tbss_non_FA</tt>), such as MO, type <span class="anchor" id="line-171"></span><span class="anchor" id="line-172"></span><p class="line867"><span class="anchor" id="line-173"></span><span class="anchor" id="line-174"></span><pre><span class="anchor" id="line-1-12"></span>tbss_sym MO</pre><span class="anchor" id="line-175"></span><p class="line862">The script first generates the symmetric mean-FA image and derived skeleton, mask and distance map, unless these have already been generated by a previous run of tbss_sym. The rest of this paragraph can be ignored if you are not interested in the details of how the symmetric skeleton is derived. First, the original (asymmetric) skeleton is dilated (thickened) by one voxel, and saved to a temporary file. Next, the symmetrised mean-FA image <tt>mean_FA_symmetrised</tt> is generated, just by flipping and averaging <tt>mean_FA</tt>. This is then skeletonised to generate the initial symmetric skeleton. This skeleton is masked by the dilated original skeleton - this step ensures that only skeleton structures that are already close to being symmetric in the original data are used in this left-right analysis. Finally, to be absolutely sure the final skeleton is exactly symmetric, it is flipped and masked with the non-flipped version, creating a symmetrised skeleton <tt>mean_FA_symmetrised_skeleton</tt>. A thresholded skeleton mask image and derived distance map are then derived from this. <span class="anchor" id="line-176"></span><span class="anchor" id="line-177"></span><p class="line862">Now, the 4D prealigned data <tt>all_FA</tt> (or non-FA equivalent, if requested) is projected onto the symmetrised skeleton, resulting in 4D file <tt>all_FA_symmetrised_skeletonised</tt> (etc.). This could now be left-right tested. However, To make this easy, two final steps are carried out: 1) The 4D dataset is left-right flipped, and the latter subtracted from the former. 2) The left half of this dataset (corresponding to the "right" side of standard space) is then zeroed, as the same information (inverted) is present on the left and right sides of the image. This results in 4D image <tt>all_FA_skeletonised_left_minus_right</tt>. <span class="anchor" id="line-178"></span><span class="anchor" id="line-179"></span><p class="line862">Therefore the simplest possible analysis with randomise is just to test whether the mean of this data is significantly greater than zero, using the -1 option instead of entering a design matrix and contrast file. This tests for L&gt;R. To test for R&gt;L, either invert the data and re-run randomise, or create an appropriate design matrix and contrast file. <span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-182"></span>
<h1 id="Displaying_TBSS_Results">Displaying TBSS Results</h1>
<span class="anchor" id="line-183"></span><p class="line867"><img align="right" alt="stats_eg.png" class="attachment" src="attachments/TBSS(2f)UserGuide/stats_eg.png" title="stats_eg.png" />  In this section we give some hints on how to present TBSS results. You might want to use either the MNI152 background image or your mean_FA study-specific image - or you may want to show TBSS results on top of both. If you use your mean_FA image as the background, make sure that you set a good display range, for example 0:0.6. For the rest of this section we'll assume that you want to show results on top of the MNI152 image and hence start by loading MNI152 into FSLView. <span class="anchor" id="line-184"></span><span class="anchor" id="line-185"></span><p class="line862">You will probably next want to load the <tt>mean_FA_skeleton</tt> image on top of your background image, to show where the skeleton was estimated, and which standard-space voxels were tested in the multi-subjects statistics. Load <tt>mean_FA_skeleton</tt> into FSLView and set its display range correctly. The lower threshold must be set to the threshold that you used in the TBSS analysis, for example 0.2. The upper level should probably be set to something like 0.7, so that you can see variation in mean FA values within the skeleton. You probably want to change the colourmap, for example to Green, and increase the transparency (with the transparency slider) so that when you load the stats image in, it is easier to see. <span class="anchor" id="line-186"></span><span class="anchor" id="line-187"></span><p class="line862">Finally, load the stats image in. If you have used TFCE-based testing in randomise, the raw t-statistic image will be named something like <tt>tbss_tstat1</tt> (which you could view to see raw tstats before significance testing), but the image you probably want is <tt>tbss_tfce_corrp_tstat1</tt>, which is the corrected p-value image (actually the values in this image are 1-p for ease of display, so that bigger is "better"). Load this into FSLView, set a colourmap such as Red-Yellow, and set the display range to something like 0.95:1, which corresponds to thresholding the results at p&lt;0.05. <span class="anchor" id="line-188"></span><span class="anchor" id="line-189"></span><p class="line874">All of the above (apart from setting the skeleton transparency, which has to be done by hand in the GUI) can be carried out with a single command (see first example image): <span class="anchor" id="line-190"></span><span class="anchor" id="line-191"></span><p class="line867"><span class="anchor" id="line-192"></span><span class="anchor" id="line-193"></span><pre><span class="anchor" id="line-1-13"></span>fslview $FSLDIR/data/standard/MNI152_T1_1mm mean_FA_skeleton -l Green -b 0.2,0.7 tbss_tfce_corrp_tstat1 -l Red-Yellow -b 0.95,1</pre><span class="anchor" id="line-194"></span><p class="line867"><img align="right" alt="stats_eg2.png" class="attachment" src="attachments/TBSS(2f)UserGuide/stats_eg2.png" title="stats_eg2.png" />  Alternatively, although showing the stats results on the TBSS skeleton is a true representation of the actual analysis carried out, some people find it easier to visualise the results if the skeletonised results are "thickened" somewhat. In order to make such a presentation easy, there is a script tbss_fill, which thickens the thresholded stats image, filling it out into the local "tracts" seen in <tt>mean_FA</tt>. For example, to apply this to the same example as above and then view in FSLView on top of the mean_FA image, run: <span class="anchor" id="line-195"></span><span class="anchor" id="line-196"></span><p class="line867"><span class="anchor" id="line-197"></span><span class="anchor" id="line-198"></span><span class="anchor" id="line-199"></span><pre><span class="anchor" id="line-1-14"></span>tbss_fill tbss_tfce_corrp_tstat1 0.95 mean_FA tbss_fill
<span class="anchor" id="line-2-4"></span>fslview mean_FA -b 0,0.6 mean_FA_skeleton -l Green -b 0.2,0.7 tbss_fill -l Red-Yellow</pre><span class="anchor" id="line-200"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-201"></span>
<h1 id="Transforming_TBSS_results_back_to_native_space">Transforming TBSS results back to native space</h1>
<span class="anchor" id="line-202"></span><p class="line874">It is possible to take one or more voxels on the mean FA skeleton and show where, in each subject's FA image, those voxels originally came from. This "back projection" is composed of one or two steps. First, the skeleton voxel is projected back from its position on the skeleton to the nearby position at the centre of the nearest tract in the subject's FA image in standard space (i.e., after the FA image had been nonlinearly registered to the target image). Second, this point can then be "inverse warped" back into the subject's native space, by inverting the nonlinear registration that was originally applied. The whole process can be viewed thus: <span class="anchor" id="line-203"></span><span class="anchor" id="line-204"></span><p class="line867"><img alt="flowchart.png" class="attachment" src="attachments/TBSS(2f)UserGuide/flowchart.png" title="flowchart.png" width="100%" /> <span class="anchor" id="line-205"></span><span class="anchor" id="line-206"></span><p class="line862">There are two obvious reasons why you might want to back-project a skeleton-space voxel (or voxels). The first is to confirm that a given skeleton point was derived from the correct tract-centre points in all subjects. This can generally be achieve by just taking the first of the back projection steps, from the skeleton to the space of the <tt>all_FA</tt> data, and viewing the back-projected points on top of <tt>all_FA</tt> (looking at each subject, i.e., timepoint, separately). The second is to take a skeleton-space voxel or set of voxels (for example, a skeleton-space blob that is significantly different between the two groups of subjects in the study) back to the space of the original subjects' data, in order to run tractography for each subject, with that result forming the tractography seed mask. <span class="anchor" id="line-207"></span><span class="anchor" id="line-208"></span><p class="line867"><strong>Option 1: just deproject &lt;skeleton-space-input-image&gt; onto the space of each nonlinearly registered subject in all_FA</strong> <span class="anchor" id="line-209"></span><span class="anchor" id="line-210"></span><p class="line874">For an example of confirming the final tract-centre projection stage, first form an image containing significant voxels from a previous randomise-based statistical analysis of the skeletonised data: <span class="anchor" id="line-211"></span><span class="anchor" id="line-212"></span><p class="line867"><span class="anchor" id="line-213"></span><span class="anchor" id="line-214"></span><span class="anchor" id="line-215"></span><span class="anchor" id="line-216"></span><pre><span class="anchor" id="line-1-15"></span>fslmaths tbss_tfce_corrp_tstat1 -thr 0.95 grot
<span class="anchor" id="line-2-5"></span>tbss_deproject grot 1
<span class="anchor" id="line-3-2"></span>fslview all_FA grot_to_all_FA -l Red-Yellow</pre><span class="anchor" id="line-217"></span><p class="line874">The 1 tells the script to just apply stage 1 of the de-projections, i.e. from skeleton space to the all_FA space. This lets you view the interesting skeleton-space voxels in the space of each subject's standard space (nonlinearly registered) FA image - as you move through the timepoints in FSLView you see each subject in turn. <span class="anchor" id="line-218"></span><span class="anchor" id="line-219"></span><p class="line867"><strong>Option 2: do the first step and also invert the nonlinear warping, to get back to subjects' native space</strong> <span class="anchor" id="line-220"></span><span class="anchor" id="line-221"></span><p class="line874">For an example of complete back-projection to the space of the native data in FA, run the following, first making sure you run the command from within the stats directory. The 2 flag tells the script to take the back-projection back to the native space: <span class="anchor" id="line-222"></span><span class="anchor" id="line-223"></span><p class="line867"><span class="anchor" id="line-224"></span><span class="anchor" id="line-225"></span><pre><span class="anchor" id="line-1-16"></span>tbss_deproject grot 2</pre><span class="anchor" id="line-226"></span><p class="line862">This results in a separate output for each subject in the stats directory. For example, if your first subject was called <tt>subject_001</tt>, you would view the results (if you are in the stats directory), with: <span class="anchor" id="line-227"></span><span class="anchor" id="line-228"></span><p class="line867"><span class="anchor" id="line-229"></span><span class="anchor" id="line-230"></span><pre><span class="anchor" id="line-1-17"></span>fslview ../FA/subject_001_FA subject_001_FA_grot -l Red-Yellow</pre><span class="anchor" id="line-231"></span><p class="line874">This is probably the space you want to transform grot into if you are going to use the result to seed tractography analysis. <span class="anchor" id="line-232"></span><span class="anchor" id="line-233"></span><p class="line862">Finally, you can add the -n flag to the end of the <tt>tbss_deproject</tt> command to tell the transformations of your original skeleton voxels to keep the exact values in your input data (rather than allowing them to be smoothly interpolated) when applying the reverse transformations. For example, if your skeleton-space image that you feed into <tt>tbss_deproject</tt> contains mask index numbers 1, 2 and 3 at different mask locations on the skeleton, you would use the -n option, and then the output images from tbss_deproject will contain the same set of index numbers without any alteration cause by the interpolations. Note that this will take a long time to run if you have lots of distinct integer values in the input image, as the deprojections are run separately for every different index number! If your data has continuous values (e.g. Z-statistic or p-values) you should not use the -n option. <span class="anchor" id="line-234"></span><span class="anchor" id="line-235"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-236"></span>
<h1 id="What.27s_new_in_this_version">What's new in this version</h1>
<span class="anchor" id="line-237"></span><p class="line867"><strong>v1.2</strong> <span class="anchor" id="line-238"></span><span class="anchor" id="line-239"></span><p class="line874">This version switched the nonlinear registration from using IRTK to using FNIRT (FMRIB's Nonlinear Registration Tool) and as a result there are some minor usage changes. FNIRT is about 15 times faster than IRTK on FA data and possibly a little more 'accurate'. A TBSS v1.2 analysis is not compatible with an older analysis; the data needs to be re-processed starting with running tbss_1_preproc (re-running earlier steps such as eddy correction and dtifit is not necessary). The usage changes are: <span class="anchor" id="line-240"></span><span class="anchor" id="line-241"></span><p class="line867"><tt>tbss_1_preproc</tt> now doesn't need a scaling factor to be chosen; FA images no longer need to be converted to be in the range 0:10000. <span class="anchor" id="line-242"></span><span class="anchor" id="line-243"></span><p class="line874">It is no longer necessary to run tbss_1_preproc before feeding non-FA images into TBSS; the data just needs to be named correctly and put in the right place (see manual). <span class="anchor" id="line-244"></span><span class="anchor" id="line-245"></span><p class="line862">The threshold entered for <tt>tbss_4_prestats</tt> is now in the same units as FA, e.g. 0.2, and no longer scaled up by a factor of 10000. <span class="anchor" id="line-246"></span><span class="anchor" id="line-247"></span><p class="line867"><strong>v1.1</strong> <span class="anchor" id="line-248"></span><span class="anchor" id="line-249"></span><p class="line874">This version introduced a standard-space mean FA image (FMRIB58_FA) for use as the target in the initial nonlinear registration. This now becomes the recommended target for the nonlinear registrations, instead of registering every subject to every other subject, and choosing the most typical. All scripts are updated to allow either way of running the registrations. <span class="anchor" id="line-250"></span><span class="anchor" id="line-251"></span><p class="line862">Script <tt>tbss_fill</tt> is added to allow "thickening" of results for ease of display. <span class="anchor" id="line-252"></span><span class="anchor" id="line-253"></span><p class="line874">Script tbss_deproject is added to allow back-projection of skeleton-space voxels into all_FA and native FA spaces. <span class="anchor" id="line-254"></span><span class="anchor" id="line-255"></span><p class="line867"><strong>v1.0</strong> <span class="anchor" id="line-256"></span><span class="anchor" id="line-257"></span><p class="line874">Original TBSS release. <span class="anchor" id="line-258"></span><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2014-07-08 15:34
</body>
</html>
