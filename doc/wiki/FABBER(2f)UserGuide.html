<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>FABBER/UserGuide</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="fsl/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="fsl/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="fsl/css/print.css">
<style type="text/css">
ul.pagetitle{
  display: inline;
  margin: 0;
  padding: 0;
  font-size: 1.5em;
}
li.pagetitle{
  display: inline;
  margin: 0;
}
td.noborder {
  border: 0;
}
</style>
</head>
<body>
<table>
<tr>
<td class="noborder">
<img src="logo.png">
</td>
<td class="noborder">
<ul class="pagetitle">
<li class="pagetitle"><a class="backlink">FABBER/UserGuide</a>
</ul>
<br><br>
[<a href="FSL.html">FSL</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]&nbsp;
</td>
</tr>
</table>
<hr>
<div id="page">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><span class="anchor" id="line-4"></span><p class="line867"><div class="FslToolContents">
<h1>Contents</h1>
<ol><li><a href="./FABBER.html">Introduction</a></li><li>User Guide<div class="contentslist"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="#Using_fabber_on_dual-echo_ASL_data">Using fabber on dual-echo ASL data</a></li><li>
<a href="#Preprocessing">Preprocessing</a></li><li>
<a href="#Command-line_syntax">Command-line syntax</a></li><li>
<a href="#Output_files">Output files</a></li><li>
<a href="#Spatial_regularization">Spatial regularization</a></li><li>
<a href="#Other_options">Other options</a></li></ol></div></div></li></ol></div> <span class="anchor" id="line-5"></span><span class="anchor" id="line-6"></span><p class="line867">
<h1 id="Using_fabber_on_dual-echo_ASL_data">Using fabber on dual-echo ASL data</h1>
<span class="anchor" id="line-7"></span><p class="line874">To run FABBER on a dual-echo ASL data set, you will need the following: <span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><ul><li>Data sets for both echo times <span class="anchor" id="line-10"></span></li><li>Stimulus information, preconvolved with the appropriate Haemodynamic Response Functions <span class="anchor" id="line-11"></span></li><li>Details of the pulse sequence used (e.g. echo times, inversion times). Currently supported models are QUIPSS II, Q2TIPS and pseudo-cASL. <span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span></li></ul><p class="line867">
<h1 id="Preprocessing">Preprocessing</h1>
<span class="anchor" id="line-14"></span><p class="line862">We assume that the high- and low-TE data sets are stored as two separate files, which should be converted into NIFTI format (<tt class="backtick">.nii.gz</tt> files) and should have the first few volumes discarded. You can remove very low frequency noise using <tt class="backtick">fslmaths</tt>, for example <span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><p class="line867"><tt class="backtick">fslmaths&nbsp;raw_highte.nii.gz&nbsp;-bptf&nbsp;50&nbsp;-1&nbsp;filtered_highte.nii.gz</tt> <span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span><p class="line867"><tt class="backtick">fslmaths&nbsp;raw_lowte.nii.gz&nbsp;-bptf&nbsp;50&nbsp;-1&nbsp;filtered_lowte.nii.gz</tt> <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span><p class="line874">will remove low-frequency noise using sigma = 50 volumes. Other types of preprocessing may be used (e.g. using Matlab) but don't rescale the data sets, since it's important to preserve the relative signal magnitude between the two echo times. <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><p class="line862">A mask image is also required, showing which voxels to perform the inference on. This can be produced manually (in <tt class="backtick">fslview</tt>) or automatically (using <a href="./BET.html">BET</a>). <span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><p class="line874">For the nonlinear QUIPSS II model, three design matrices are required: BOLD, CBF, and Static Magnetization are all time-varying. FEAT can be used to prepare these three design-matrix files; they should simply be the stimulus convolved with a suitable Haemodynamic Response Function. A standard HRF can be used for the BOLD design matrix and a quicker-responding HRF should be used for the CBF and Static Magnetization design matrices. It's possible to use multiple regressors in any of these files (for example, a derivative term) if desired. A set of nuisance regressors (e.g., motion) may also be provided as an additional input. <span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span><p class="line867">
<h1 id="Command-line_syntax">Command-line syntax</h1>
<span class="anchor" id="line-27"></span><p class="line874">The typical syntax for analysing a QUIPSS II data set is: <span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span><p class="line867"><tt class="backtick">fabber&nbsp;--method=vb&nbsp;--model=quipss2&nbsp;--noise=ar&nbsp;--num-echoes=2&nbsp;--output=&lt;output_directory&gt;&nbsp;--data1=&lt;low_te_data&gt;&nbsp;--data2=&lt;high_te_data&gt;&nbsp;--mask=&lt;mask_image&gt;&nbsp;--bold-basis=&lt;bold_design&gt;&nbsp;--cbf-basis=&lt;cbf_design&gt;&nbsp;--statmag-basis=&lt;statmag_design&gt;</tt> <span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span><p class="line874">There are a number of additional numerical parameters that can be added to adjust the forward model to fit the details of your particular scan. For QUIPSS II, these parameters are <span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span><p class="line862">Inversion times in seconds (defaults: <tt class="backtick">--ti1=0.6</tt>, <tt class="backtick">--ti2=1.5</tt>) Echo times in milliseconds (defaults: <tt class="backtick">--te1=9.1</tt>, <tt class="backtick">--te2=30</tt>) Tag/control order: (default: <tt class="backtick">--tag-pattern=TC</tt>). The pattern of Cs and Ts will be repeated as necessary to fill the entire scan length. In addition, the T1 of blood and the inversion efficiency are normally treated as constants (defaults: <tt class="backtick">--t1b=1.66,&nbsp;--inv-eff=1.0</tt>). These can be given uncertainties (and inferred upon) by providing nonzero standard deviations for the <tt class="backtick">--t1b-stdev=</tt> and <tt class="backtick">--inv-eff-stdev=</tt> options. For a complete list of general command-line options, type <span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><ul><li style="list-style-type:none"><p class="line891"><tt class="backtick">fabber&nbsp;--help</tt> <span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span></li></ul><p class="line874">For parameters specific to the QUIPSS II model, type: <span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span><ul><li style="list-style-type:none"><p class="line891"><tt class="backtick">fabber&nbsp;--help&nbsp;--model=quipss2</tt> <span class="anchor" id="line-40"></span><span class="anchor" id="line-41"></span></li></ul><p class="line874">The other models available are: q2tips-dualecho and pcasl-dualecho <span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span><p class="line867">
<h1 id="Output_files">Output files</h1>
<span class="anchor" id="line-44"></span><p class="line862">After FABBER finishes, the output folder will contain point estimate and pseudo-Z-statistic images for each of the forward model parameters, stored in <tt class="backtick">mean_&lt;parameter_name&gt;.nii.gz</tt> and <tt class="backtick">zstat_&lt;parameter_name&gt;.nii.gz</tt> respectively. To find significant stimulus-correlated changes in the BOLD effect, CBF, and Static Magnetization, look at <tt class="backtick">zstat_BOLD_abschg_1.nii.gz</tt>, <tt class="backtick">zstat_Q_abschg_1.nii.gz</tt>, and <tt class="backtick">zstat_M_abschg_1.nii.gz</tt>. For quantitative parameter estimates, use the various <tt class="backtick">mean_*.nii.gz</tt> files (e.g. % CBF change is simply <em>100 * mean_Q_abschg_1 / mean_Q0</em>). For more detailed analysis of the Bayesian results (e.g. looking for covariance in parameter uncertainties), use <tt class="backtick">finalMeans.nii.gz</tt> and <tt class="backtick">finalCovariance.nii.gz</tt>. These completely describe the multivariate normal distribution on the forward model parameters (in the NIFTI formats for vectors and symmetric matrices). Some noise parameter distributions are also appended to this distribution. The parameter names corresponding to the vector elements are saved (one per line) in <tt class="backtick">paramnames.txt</tt>. <span class="anchor" id="line-45"></span><span class="anchor" id="line-46"></span><p class="line862">If you encounter problems, start by reading the output carefully and looking at the <tt class="backtick">logfile</tt> — there may be some useful warning messages there. <span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span><p class="line867">
<h1 id="Spatial_regularization">Spatial regularization</h1>
<span class="anchor" id="line-49"></span><p class="line862">It is also possible to use spatial priors with <tt class="backtick">fabber</tt>, these are preferable to spatially smoothing the data before analysis, since that can result in interaction with the non-linear model.  <span class="anchor" id="line-50"></span><tt class="backtick">--method=spatialvb</tt>: This instructs fabber to use spatial priors, i.e. to take spatial homogeneity between neighbouring voxels into account. This produces smoother resulting parameter images, but in a more principled manner than simply smoothing data or results. The implementation is based on the approach described in  <span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><div class="references"><span class="anchor" id="line-1-1"></span><p class="line862">Penny, W.D., Trujillo-Barreto, N.J., Friston K.J., "Bayesian fMRI time series analysis with spatial priors", <a class="nonexistent" href="./NeuroImage.html">NeuroImage</a> 24:2, pp.350–362, 2005, with some minor modifications.  </div><span class="anchor" id="line-54"></span><p class="line867"><tt class="backtick">--param-spatial-priors</tt>=&lt;choice_of_prior_forms&gt;: Use only with <tt class="backtick">--method=spatialvb</tt>. This makes it possible to choose different priors for each parameter. This should be a string with one letter per forward-model parameter. S is the spatial prior as above (default), N is a nonspatial prior, and D is a Gaussian-process based prior for combined spatial and non-spatial prior inference. A single + sign may be used to repeat the preceding letter zero or more times in order to reach the correct length. For example, <tt class="backtick">--param-spatial-priors=SN+D</tt> would use a spatial prior on the first parameter, combination prior on the last, and nonspatial priors on all others. Note that the D option only make sense when an informative non-spatial prior is specified by --fwd-initial-prior; for parameters without informative nonspatial priors, use S. More details of the D prior can be found in the Groves 2009 <a class="nonexistent" href="./NeuroImage.html">NeuroImage</a> paper.  <span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><p class="line867">
<h1 id="Other_options">Other options</h1>
<span class="anchor" id="line-58"></span><p class="line867"><tt class="backtick">--nuisance-basis=&lt;noise_regressors&gt;</tt>: include additional regressors in the QUIPSS II model that act directly on the signal (not echo-time-weighted). Separate regression parameters are used for each echo time. <span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span><p class="line867"><tt class="backtick">--noise=white&nbsp;(instead&nbsp;of&nbsp;--noise=ar)</tt>: Use a white noise model instead of AR(1). By default this will use the same noise variance for all data points. Add <tt class="backtick">--noise-pattern=12</tt> to use different variances for odd and even (i.e. TE1 and TE2) data points. <span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span><p class="line867"><tt class="backtick">--fwd-initial-prior=&lt;prior_vest_file&gt;</tt>: Use an informative prior, specified by a symmetric matrix in a VEST-format file. For an N-parameter model, the matrix should be N+1 by N+1: an N-by-N prior covariance matrix in the top left (must be positive definite), supplemented by an extra column and row vector giving the prior mean of each parameter (must give the same values in both locations). The bottom-right corner must be the number one. <span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span><p class="line867"><tt class="backtick">--allow-bad-voxels</tt>: By default <tt class="backtick">fabber</tt> will halt if a numerical error arises during the calculation of any voxel. Using this option, it will simply issue a warning and skip to the next voxel; this should be used with caution. Each time a voxel is skipped you'll get a "Going on to the next voxel" message in the logfile — if you have more than a few of these then it's likely that other voxels are also experiencing convergence problems. If you are using your own forward model you may be able to correct this by changing the parameterization to make the signal more linear with respect to the parameters. <span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span><p class="line867"><tt class="backtick">--save-residuals</tt> and <tt class="backtick">--save-model-fit</tt>: produce 4D data sets for the residuals and the model fit. The sum of these two files should equal the original data (with the mask applied and the echo times interleaved).  <tt class="backtick">-@&nbsp;&lt;options_file&gt;</tt>: Read a list of options from a text file, as if they were typed at the command line. <span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><p class="line867"><tt class="backtick">--ar1-cross-terms=dual</tt>, <tt class="backtick">same</tt>, or <tt class="backtick">none</tt>: By default, an independent autoregressive noise model is used for each echo time (<tt class="backtick">none</tt>). However, the noise between the two echo times is no independent, so this default tends to overestimate the amount of information in the data. By selecting <tt class="backtick">same</tt> or <tt class="backtick">dual</tt>, you can introduce one or two cross-terms into the AR(1) noise models which partially model this correlation. <tt class="backtick">dual</tt> is recommended for dual-echo ASL data. <span class="anchor" id="line-69"></span><hr /><p class="line874"> <span class="anchor" id="line-70"></span><a href="./CategoryFABBER.html">CategoryFABBER</a> <span class="anchor" id="line-71"></span><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2014-07-08 15:33
</body>
</html>
