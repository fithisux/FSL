<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>FSLVBM/UserGuide</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="fsl/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="fsl/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="fsl/css/print.css">
<style type="text/css">
ul.pagetitle{
  display: inline;
  margin: 0;
  padding: 0;
  font-size: 1.5em;
}
li.pagetitle{
  display: inline;
  margin: 0;
}
td.noborder {
  border: 0;
}
</style>
</head>
<body>
<table>
<tr>
<td class="noborder">
<img src="logo.png">
</td>
<td class="noborder">
<ul class="pagetitle">
<li class="pagetitle"><a class="backlink">FSLVBM/UserGuide</a>
</ul>
<br><br>
[<a href="FSL.html">FSL</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]&nbsp;
</td>
</tr>
</table>
<hr>
<div id="page">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><p class="line867"><div class="FslToolContents">
<h1>Contents</h1>
<ol><li><a href="./FSLVBM.html">Introduction</a></li><li>User Guide<div class="contentslist"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="#Running_FSL-VBM_-_Overview">Running FSL-VBM - Overview</a></li><li>
<a href="#Running_FSL-VBM_-_In_detail">Running FSL-VBM - In detail</a><ol><li>
<a href="#A_-_Prepare_your_data_for_the_FSL-VBM_study">A - Prepare your data for the FSL-VBM study</a></li><li>
<a href="#B_-_Extracting_brain_information:_fslvbm_1_bet">B - Extracting brain information: fslvbm_1_bet</a></li><li>
<a href="#C_-_Creating_the_template:_fslvbm_2_template">C - Creating the template: fslvbm_2_template</a></li><li>
<a href="#D_-_Processing_the_native_GM_images:_fslvbm_3_proc">D - Processing the native GM images: fslvbm_3_proc</a></li><li>
<a href="#E_-_Displaying_your_FSL-VBM_results">E - Displaying your FSL-VBM results</a></li><li>
<a href="#E1_-_Displaying_TFCE-based_thresholding_results">E1 - Displaying TFCE-based thresholding results</a></li><li>
<a href="#E2_-_Displaying_cluster-based_thresholding_results">E2 - Displaying cluster-based thresholding results</a></li></ol></li><li>
<a href="#What.27s_new_in_this_version">What's new in this version</a></li></ol></div></div></li></ol></div> <span class="anchor" id="line-3"></span><span class="anchor" id="line-4"></span><p class="line867">
<h1 id="Running_FSL-VBM_-_Overview">Running FSL-VBM - Overview</h1>
<span class="anchor" id="line-5"></span><p class="line874">Running FSL-VBM involves a few simple steps: <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><ul><li>prepare your T1-weighted images in the right format <span class="anchor" id="line-8"></span></li><li><p class="line891"><tt class="backtick">fslvbm_1_bet</tt> - carry out brain extraction on all T1 images <span class="anchor" id="line-9"></span></li><li><p class="line891"><tt class="backtick">fslvbm_2_template</tt> - create the study-specific symmetric grey matter template <span class="anchor" id="line-10"></span></li><li><p class="line891"><tt class="backtick">fslvbm_3_proc</tt> - register all the grey matter images to the template, modulate and smooth them with different kernel sizes and finally runs an initial GLM analysis for qualitative evaluation <span class="anchor" id="line-11"></span></li><li><p class="line891"><tt class="backtick">randomise</tt> - carry out voxelwise GLM analysis using permutation testing <span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span></li></ul><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-14"></span>
<h1 id="Running_FSL-VBM_-_In_detail">Running FSL-VBM - In detail</h1>
<span class="anchor" id="line-15"></span><p class="line867">
<h2 id="A_-_Prepare_your_data_for_the_FSL-VBM_study">A - Prepare your data for the FSL-VBM study</h2>
<span class="anchor" id="line-16"></span><p class="line874">a) Place all your T1-weighted data in your FSL-VBM directory. For instance: <span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span><p class="line867"><tt class="backtick">mkdir&nbsp;my_fsl_vbm</tt> <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span><p class="line874">Then copy into your FSL-VBM directory all of your subjects' T1 images, giving each subject's T1 image a different name, preferably with each prefix corresponding to each of your group, for example: <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><p class="line867"><tt class="backtick">CON_2304.nii.gz</tt><br>
 <tt class="backtick">CON_2878.nii.gz</tt><br>
 <tt class="backtick">CON_3456.nii.gz</tt><br>
 <tt class="backtick">CON_4133.nii.gz</tt><br>
 <tt class="backtick">CON_4690.nii.gz</tt><br>
 <tt class="backtick">PAT_2042.nii.gz</tt><br>
 <tt class="backtick">PAT_2280.nii.gz</tt><br>
 <tt class="backtick">PAT_2632.nii.gz</tt><br>
 <tt class="backtick">PAT_3193.nii.gz</tt><br>
 <tt class="backtick">PAT_4134.nii.gz</tt><br>
 <tt class="backtick">PAT_5357.nii.gz</tt><br>
 <tt class="backtick">PAT_6659.nii.gz</tt> <span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><p class="line862">b) If you have more than one group and the number of subjects in each is not the same, choose (at random) among the biggest group(s) the images that you will use to create the study-specific template, with the same number as of the smallest group (in order to create an unbiased template - see below for further explanation). Once you've chosen which T1 images to keep to build the template, put all the selected names of exams in a file called <tt class="backtick">template_list</tt> in your FSL-VBM directory. <span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span><p class="line874">All your different populations included in this study MUST be represented in the template construction. <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><p class="line874">For instance, as we have only 5 controls for 7 patients, we have to select 5 patients out of the 7: <span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span><p class="line867"><tt class="backtick">for&nbsp;g&nbsp;in&nbsp;CON_2304.nii.gz&nbsp;CON_2878.nii.gz&nbsp;CON_3456.nii.gz&nbsp;CON_4133.nii.gz&nbsp;CON_4690.nii.gz&nbsp;PAT_2042.nii.gz&nbsp;\</tt><br>
 <tt class="backtick">PAT_2632.nii.gz&nbsp;PAT_3193.nii.gz&nbsp;PAT_4134.nii.gz&nbsp;PAT_6659.nii.gz;&nbsp;do</tt><br>
 <tt class="backtick">echo&nbsp;$g&nbsp;&gt;&gt;&nbsp;template_list</tt><br>
 <tt class="backtick">done</tt> <span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span><p class="line874">c) At this point you should have a quick look at all your data to check that all subjects' structural images are what you expected: <span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><p class="line867"><tt>slicesdir&nbsp;`imglob&nbsp;*`</tt> <span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span><p class="line862">The <tt class="backtick">imglob</tt> command lists all of your input images. The <tt class="backtick">slicesdir</tt> command takes the list of images and creates a simple web-page containing snapshots for each of the images. Once it has finished running it tells you the name of the web page to open in your web browser, to view the snapshots. Have a careful look. <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><p class="line862">d) It's a good idea to consider your cross-subject statistical model <strong>before</strong> you run the FSL-VBM analysis. So you should at this point create your <tt class="backtick">design.mat</tt> and <tt class="backtick">design.con</tt> in your FSL-VBM directory; see the <a href="./Randomise.html">randomise manual</a>. <span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><p class="line867"><strong>WARNING!!! </strong>The order of the rows in your design.mat model MUST match the order of your images when doing an 'ls' command in your FSL-VBM directory. <span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><p class="line867">
<h2 id="B_-_Extracting_brain_information:_fslvbm_1_bet">B - Extracting brain information: fslvbm_1_bet</h2>
<span class="anchor" id="line-43"></span><p class="line862">The first FSL-VBM script moves all your input images into a new <tt class="backtick">struc</tt> subdirectory (and adding "_struc" to the end of each filename). It then runs brain extraction on the images. You can either use the <tt class="backtick">-b</tt> option to get default BET behaviour, or use the <tt class="backtick">-N</tt> option if your images include a lot of neck (which most of the time confounds the BET preprocessing). <span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><p class="line874">To run this first script, just type: <span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><p class="line867"><tt class="backtick">fslvbm_1_bet&nbsp;-b</tt> <span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><p class="line874">or <span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span><p class="line867"><tt class="backtick">fslvbm_1_bet&nbsp;-N</tt> <span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><p class="line874">in your FSL-VBM directory. <span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span><p class="line862">At the end of this step, it is once again worth <strong>CHECKING</strong> the brain images (*_brain.*) in your <tt class="backtick">struc</tt> directory by loading the new slicesdir output into a web browser. Brain extraction is the step which is the most likely to need tweaking in the FSL-VBM protocol. It might not be too much of an issue if you get "more" than the grey matter (eyes, dura etc.) though this will need careful checking before running your statistics. If you do not get good results with either option (i.e., if some images are missing some grey matter), you can try adding other <a href="./BET.html">bet</a> options after the <tt class="backtick">-b</tt> or <tt class="backtick">-N</tt> option. <span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><p class="line862">If you later want to add more subjects to your analysis then just put the new subjects' images inside the toplevel directory (e.g. <tt class="backtick">my_fsl_vbm</tt>) and re-run <tt class="backtick">fslvbm_1_bet</tt>. Don't forget to update <tt class="backtick">template_list</tt> if necessary. <span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span><p class="line867">
<h2 id="C_-_Creating_the_template:_fslvbm_2_template">C - Creating the template: fslvbm_2_template</h2>
<span class="anchor" id="line-60"></span><p class="line867"><img align="right" alt="template.jpg" class="attachment" height="205" src="attachments/FSLVBM(2f)UserGuide/template.jpg" title="template.jpg" /> The second step of the FSL-VBM protocol creates the study-specific grey matter (GM) template. <span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span><p class="line874">First, all brain-extracted images are segmented into GM, WM and CSF. Then, GM images selected in the template_list file (*_struc_GM) are affine-registered to the GM ICBM-152 template, concatenated and averaged. This averaged image is then flipped along the x-axis and the two mirror images then re-averaged to obtain a first-pass, study-specific "affine" GM template ("template_GM_init"). Second, the template_list GM images are re-registered to this "affine" GM template using non-linear registration, concatenated into a 4D image called "template_4D_GM", averaged, flipped along the x-axis. Both mirror images are then averaged to create the final symmetric, study-specific "non-linear" GM template at 2x2x2mm3 resolution in standard space. <span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span><p class="line874">If you have different populations, they should all be represented in your template. You should use the same number of subjects from each in the construction of the study-specific template. This is to avoid any bias during the registration step that would have consisted in favouring one of the groups. For example, if you have only controls in your template, or more controls than patients, it is likely that the non-linear registration would be more accurate for your control subjects than for your patients. Then you cannot distinguish, in your results showing differences in the GM volume distribution between the two groups, what is actually disease-related from what is registration-related! <span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span><p class="line862">For this step, you have two options: either you want to create a template based on an affine registration (<tt class="backtick">-a</tt> option) of GM images to the GM ICBM-152 template, or on a non-linear registration (<tt class="backtick">-n</tt> option). <span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><p class="line874">So to run this second step script, just type: <span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span><p class="line867"><tt class="backtick">fslvbm_2_template&nbsp;-a</tt> <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><p class="line874">or <span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><p class="line867"><tt class="backtick">fslvbm_2_template&nbsp;-n</tt> <span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><p class="line874">in your FSL-VBM directory. <span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span><p class="line862">Once this is completed, CHECK the "template_GM_4D" image in <tt class="backtick">struc</tt> with the movie loop in fslview. <span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span><p class="line867">
<h2 id="D_-_Processing_the_native_GM_images:_fslvbm_3_proc">D - Processing the native GM images: fslvbm_3_proc</h2>
<span class="anchor" id="line-81"></span><p class="line862">The final script will non-linearly register all your GM images to the study-specific template and concatenate them into a 4D image ("GM_merg") in the <tt class="backtick">stats</tt> directory in your working FSL-VBM directory. The FSL-VBM protocol also introduces a compensation (or "modulation") for the contraction/enlargement due to the non-linear component of the transformation: each voxel of each registered grey matter image is multiplied by the Jacobian of the warp field (see Good et al., 2001). All the modulated registered GM images are concatenated into a 4D image in the stats directory ("GM_mod_merg") and then smoothed ("GM_mod_merg_s3" for instance) by a range of Gaussian kernels; sigma = 2, 3, 4mm, i.e., approximately from FWHM = 2x2.3 = 4.6mm to FWHM = 9mm. <span class="anchor" id="line-82"></span><span class="anchor" id="line-83"></span><p class="line862">Finally, this last step gets everything ready for you to run permutation-based non-parametric inference using the design.mat and design.con which you supplied, a mask of the GM ("GM_mask") and the 4D multi-subject concatenated processed data (e.g. "GM_mod_merg_s3"). The script runs randomise with inference (generation of p-value maps) turned off, so that it very quickly creates just the raw tstat maps. These tstats maps should help you decide which smoothing is the most relevant to feed into a full run of randomise, and which threshold to use for the cluster-based thresholding (option <tt class="backtick">-c</tt> in the <a href="./Randomise.html">randomise command</a>); however, in general we would recommend using the TFCE option (-T) instead of the cluster-based thresholding. <span class="anchor" id="line-84"></span><span class="anchor" id="line-85"></span><p class="line867"><strong>WARNING!!!</strong> By default fslvbm_3_proc concatenates the images in alphabetical order (following the names that they started with); make sure this matches the subject ordering assumed in your design.mat model. <span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span><p class="line874">All of the above is done simply by running the script: <span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span><p class="line867"><tt class="backtick">fslvbm_3_proc</tt> <span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span><p class="line874">in your FSL-VBM directory. <span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span><p class="line862">Please do not forget the final <strong>CHECK</strong> of the 4D image of modulated registered GM images "GM_mod_merg" using the movie loop in fslview. <span class="anchor" id="line-94"></span><span class="anchor" id="line-95"></span><p class="line867">
<h2 id="E_-_Displaying_your_FSL-VBM_results">E - Displaying your FSL-VBM results</h2>
<span class="anchor" id="line-96"></span><p class="line867"><img align="right" alt="results.jpg" class="attachment" height="205" src="attachments/FSLVBM(2f)UserGuide/results.jpg" title="results.jpg" /> We strongly recommend using randomise (permutation testing) for inference in VBM-style analysis and not Gaussian random field theory (GRF), as the approximations underlying the latter are not generally appropriate in such analyses. <span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><p class="line867">
<h2 id="E1_-_Displaying_TFCE-based_thresholding_results">E1 - Displaying TFCE-based thresholding results</h2>
<span class="anchor" id="line-99"></span><p class="line874">Choose the most appropriate smoothing (e.g., sigma=3mm) for the TFCE-based analysis. If you want to apply a different smoothing than already applied, you can do so (e.g., sigma=6mm) with: <span class="anchor" id="line-100"></span><span class="anchor" id="line-101"></span><p class="line867"><tt class="backtick">fslmaths&nbsp;GM_mod_merg&nbsp;-s&nbsp;6&nbsp;GM_mod_merg_s6</tt> <span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span><p class="line862">Having chosen the most appropriate smoothing (e.g. sigma = 3mm), run randomise (see <a href="./Randomise.html">randomise usage</a>), for instance: <span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><p class="line867"><tt class="backtick">randomise&nbsp;-i&nbsp;GM_mod_merg_s3&nbsp;-m&nbsp;GM_mask&nbsp;-o&nbsp;fslvbm&nbsp;-d&nbsp;design.mat&nbsp;-t&nbsp;design.con&nbsp;-T&nbsp;-n&nbsp;5000</tt> <span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><p class="line874">You can then view the (1-p) corrected p-value images in FSLView: <span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span><p class="line867"><tt class="backtick">fslview&nbsp;$FSLDIR/data/standard/MNI152_T1_2mm&nbsp;fslvbm_tfce_corrp_tstat1&nbsp;-l&nbsp;Red-Yellow&nbsp;-b&nbsp;0.949,1</tt> <span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span><p class="line867">
<h2 id="E2_-_Displaying_cluster-based_thresholding_results">E2 - Displaying cluster-based thresholding results</h2>
<span class="anchor" id="line-112"></span><p class="line862">Once you have chosen the most appropriate smoothing (e.g. sigma = 3mm) and threshold (e.g. t &gt; 2.3) for the cluster-based correction, then feed them into a full run of randomise (see randomise usage), for instance: <span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span><p class="line867"><tt class="backtick">randomise&nbsp;-i&nbsp;GM_mod_merg_s3&nbsp;-m&nbsp;GM_mask&nbsp;-o&nbsp;fslvbm&nbsp;-d&nbsp;design.mat&nbsp;-t&nbsp;design.con&nbsp;-c&nbsp;2.3&nbsp;-n&nbsp;5000</tt> <span class="anchor" id="line-115"></span><span class="anchor" id="line-116"></span><p class="line874">Then you can threshold your "_clustere_corrp_" images (corrected p-values maps) at 0.95 to keep only the significant clusters and use it to mask the corresponding tstats map: <span class="anchor" id="line-117"></span><span class="anchor" id="line-118"></span><p class="line867"><tt class="backtick">fslmaths&nbsp;fslvbm_clustere_corrp_tstat1&nbsp;-thr&nbsp;0.95&nbsp;-bin&nbsp;mask_pcorrected</tt> <span class="anchor" id="line-119"></span><span class="anchor" id="line-120"></span><p class="line867"><tt class="backtick">fslmaths&nbsp;fslvbm_tstat1&nbsp;-mas&nbsp;mask_pcorrected&nbsp;fslvbm_tstat1_corrected</tt> <span class="anchor" id="line-121"></span><span class="anchor" id="line-122"></span><p class="line874">before displaying it with fslview overlaid on the template_GM or the MNI152 template for example: <span class="anchor" id="line-123"></span><span class="anchor" id="line-124"></span><p class="line867"><tt class="backtick">fslview&nbsp;$FSLDIR/data/standard/MNI152_T1_2mm&nbsp;fslvbm_tstat1_corrected&nbsp;-l&nbsp;Red-Yellow&nbsp;-b&nbsp;2.3,4</tt> <span class="anchor" id="line-125"></span><span class="anchor" id="line-126"></span><p class="line862">To report information about clusters in the results from randomise, see the <a href="./Cluster.html#reporting">cluster</a> tool. <span class="anchor" id="line-127"></span><span class="anchor" id="line-128"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-129"></span><span class="anchor" id="New"></span> <span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span><p class="line867">
<h1 id="What.27s_new_in_this_version">What's new in this version</h1>
<span class="anchor" id="line-132"></span><p class="line874">v1.1 <span class="anchor" id="line-133"></span><span class="anchor" id="line-134"></span><p class="line862">This version switched the nonlinear registration from using IRTK to using <a href="./FNIRT.html">FNIRT</a> (FMRIB's Nonlinear Registration Tool) and as a result there are some minor usage changes. FNIRT is about 10-15 times faster than IRTK on structural data and possibly a little more 'accurate'. An FSL-VBM v1.1 analysis is <strong>not</strong> compatible with an older analysis. <span class="anchor" id="line-135"></span><span class="anchor" id="line-136"></span><p class="line874">tbss_1_preproc is no longer used. <span class="anchor" id="line-137"></span><span class="anchor" id="line-138"></span><p class="line874">FAST4 is now used for segmentation instead of FAST3. <span class="anchor" id="line-139"></span><span class="anchor" id="line-140"></span><p class="line874">v1.0 <span class="anchor" id="line-141"></span><span class="anchor" id="line-142"></span><p class="line874">Original FSL-VBM release. <span class="anchor" id="line-143"></span><span class="anchor" id="line-144"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-145"></span><a href="./CategoryFSLVBM.html">CategoryFSLVBM</a> <span class="anchor" id="line-146"></span><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2014-07-08 15:33
</body>
</html>
